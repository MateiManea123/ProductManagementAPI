<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/Handlers/CreateProductHandler.cs">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/Handlers/CreateProductHandler.cs" />
              <option name="originalContent" value="using System;&#10;using System.Collections.Generic;&#10;using System.Diagnostics;&#10;using System.Security.Cryptography;&#10;using System.Text;&#10;using System.Threading;&#10;using System.Threading.Tasks;&#10;using AutoMapper;&#10;using Microsoft.Extensions.Logging;&#10;&#10;namespace ProductModule&#10;{&#10;    public sealed class CreateProductHandler&#10;    {&#10;        private readonly IProductRepository _repo;&#10;        private readonly ICacheService _cache;&#10;        private readonly IMapper _mapper;&#10;        private readonly ILogger&lt;CreateProductHandler&gt; _logger;&#10;&#10;        public CreateProductHandler(IProductRepository repo, ICacheService cache, IMapper mapper, ILogger&lt;CreateProductHandler&gt; logger)&#10;        {&#10;            _repo = repo;&#10;            _cache = cache;&#10;            _mapper = mapper;&#10;            _logger = logger;&#10;        }&#10;&#10;        public async Task&lt;ProductProfileDto&gt; HandleAsync(CreateProductProfileRequest request, CancellationToken ct = default)&#10;        {&#10;            var opId = GenerateOperationId();&#10;            using var scope = _logger.BeginScope(new Dictionary&lt;string, object&gt;&#10;            {&#10;                [&quot;OperationId&quot;] = opId,&#10;                [&quot;SKU&quot;] = request.SKU,&#10;                [&quot;Category&quot;] = request.Category.ToString()&#10;            });&#10;&#10;            var totalSw = Stopwatch.StartNew();&#10;&#10;            _logger.LogInformation(new EventId(ProductLogEvents.ProductCreationStarted, nameof(ProductLogEvents.ProductCreationStarted)),&#10;                &quot;Starting product creation. Name={Name}, Brand={Brand}, SKU={SKU}, Category={Category}&quot;,&#10;                request.Name, request.Brand, request.SKU, request.Category);&#10;&#10;            TimeSpan validationDuration = TimeSpan.Zero;&#10;            TimeSpan dbDuration = TimeSpan.Zero;&#10;&#10;            try&#10;            {&#10;                // Validation phase timing&#10;                var validationSw = Stopwatch.StartNew();&#10;&#10;                _logger.LogInformation(new EventId(ProductLogEvents.SKUValidationPerformed, nameof(ProductLogEvents.SKUValidationPerformed)),&#10;                    &quot;Validating SKU uniqueness. SKU={SKU}&quot;, request.SKU);&#10;&#10;                if (string.IsNullOrWhiteSpace(request.SKU))&#10;                {&#10;                    throw new ArgumentException(&quot;SKU is required&quot;, nameof(request.SKU));&#10;                }&#10;&#10;                if (await _repo.SkuExistsAsync(request.SKU, ct))&#10;                {&#10;                    _logger.LogWarning(new EventId(ProductLogEvents.ProductValidationFailed, nameof(ProductLogEvents.ProductValidationFailed)),&#10;                        &quot;SKU already exists. SKU={SKU}&quot;, request.SKU);&#10;                    throw new InvalidOperationException($&quot;Product with SKU '{request.SKU}' already exists.&quot;);&#10;                }&#10;&#10;                _logger.LogInformation(new EventId(ProductLogEvents.StockValidationPerformed, nameof(ProductLogEvents.StockValidationPerformed)),&#10;                    &quot;Validating stock. StockQuantity={Stock}&quot;, request.StockQuantity);&#10;&#10;                if (request.StockQuantity &lt; 0)&#10;                {&#10;                    _logger.LogWarning(new EventId(ProductLogEvents.ProductValidationFailed, nameof(ProductLogEvents.ProductValidationFailed)),&#10;                        &quot;Invalid stock quantity. StockQuantity={Stock}&quot;, request.StockQuantity);&#10;                    throw new ArgumentOutOfRangeException(nameof(request.StockQuantity), &quot;Stock quantity cannot be negative.&quot;);&#10;                }&#10;&#10;                validationSw.Stop();&#10;                validationDuration = validationSw.Elapsed;&#10;&#10;                // Map to Product using advanced mapping&#10;                var product = _mapper.Map&lt;Product&gt;(request);&#10;&#10;                // DB operations timing&#10;                var dbSw = Stopwatch.StartNew();&#10;                _logger.LogInformation(new EventId(ProductLogEvents.DatabaseOperationStarted, nameof(ProductLogEvents.DatabaseOperationStarted)),&#10;                    &quot;Adding product to database. SKU={SKU}&quot;, product.SKU);&#10;&#10;                await _repo.AddAsync(product, ct);&#10;                await _repo.SaveChangesAsync(ct);&#10;&#10;                dbSw.Stop();&#10;                dbDuration = dbSw.Elapsed;&#10;&#10;                _logger.LogInformation(new EventId(ProductLogEvents.DatabaseOperationCompleted, nameof(ProductLogEvents.DatabaseOperationCompleted)),&#10;                    &quot;Database operation completed. ProductId={ProductId}&quot;, product.Id);&#10;&#10;                // Cache invalidation&#10;                await _cache.RemoveAsync(&quot;all_products&quot;, ct);&#10;                _logger.LogInformation(new EventId(ProductLogEvents.CacheOperationPerformed, nameof(ProductLogEvents.CacheOperationPerformed)),&#10;                    &quot;Cache invalidated. Key={Key}&quot;, &quot;all_products&quot;);&#10;&#10;                // Map to DTO with conditional mapping/resolvers&#10;                var dto = _mapper.Map&lt;ProductProfileDto&gt;(product);&#10;&#10;                totalSw.Stop();&#10;                var metrics = new ProductCreationMetrics(&#10;                    OperationId: opId,&#10;                    ProductName: product.Name,&#10;                    SKU: product.SKU,&#10;                    Category: product.Category,&#10;                    ValidationDuration: validationDuration,&#10;                    DatabaseSaveDuration: dbDuration,&#10;                    TotalDuration: totalSw.Elapsed,&#10;                    Success: true,&#10;                    ErrorReason: null&#10;                );&#10;&#10;                _logger.LogProductCreationMetrics(metrics);&#10;&#10;                return dto;&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                totalSw.Stop();&#10;                var metrics = new ProductCreationMetrics(&#10;                    OperationId: opId,&#10;                    ProductName: request.Name,&#10;                    SKU: request.SKU,&#10;                    Category: request.Category,&#10;                    ValidationDuration: validationDuration,&#10;                    DatabaseSaveDuration: dbDuration,&#10;                    TotalDuration: totalSw.Elapsed,&#10;                    Success: false,&#10;                    ErrorReason: ex.Message&#10;                );&#10;&#10;                _logger.LogError(new EventId(ProductLogEvents.ProductValidationFailed, nameof(ProductLogEvents.ProductValidationFailed)), ex,&#10;                    &quot;Product creation failed. Name={Name}, SKU={SKU}, Category={Category}, Reason={Reason}&quot;,&#10;                    request.Name, request.SKU, request.Category, ex.Message);&#10;&#10;                _logger.LogProductCreationMetrics(metrics);&#10;                throw;&#10;            }&#10;        }&#10;&#10;        private static string GenerateOperationId()&#10;        {&#10;            const string chars = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;;&#10;            var bytes = new byte[8];&#10;            RandomNumberGenerator.Fill(bytes);&#10;            var sb = new StringBuilder(8);&#10;            foreach (var b in bytes)&#10;            {&#10;                sb.Append(chars[b % chars.Length]);&#10;            }&#10;            return sb.ToString();&#10;        }&#10;    }&#10;}&#10;using System;&#10;&#10;namespace ProductModule&#10;{&#10;    public enum ProductCategory&#10;    {&#10;        Electronics = 0,&#10;        Clothing = 1,&#10;        Books = 2,&#10;        Home = 3&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="using System;&#10;using System.Collections.Generic;&#10;using System.Diagnostics;&#10;using System.Security.Cryptography;&#10;using System.Text;&#10;using System.Threading;&#10;using System.Threading.Tasks;&#10;using AutoMapper;&#10;using Microsoft.Extensions.Logging;&#10;&#10;namespace ProductModule&#10;{&#10;    public sealed class CreateProductHandler&#10;    {&#10;        private readonly IProductRepository _repo;&#10;        private readonly ICacheService _cache;&#10;        private readonly IMapper _mapper;&#10;        private readonly ILogger&lt;CreateProductHandler&gt; _logger;&#10;&#10;        public CreateProductHandler(IProductRepository repo, ICacheService cache, IMapper mapper, ILogger&lt;CreateProductHandler&gt; logger)&#10;        {&#10;            _repo = repo;&#10;            _cache = cache;&#10;            _mapper = mapper;&#10;            _logger = logger;&#10;        }&#10;&#10;        public async Task&lt;ProductProfileDto&gt; HandleAsync(CreateProductProfileRequest request, CancellationToken ct = default)&#10;        {&#10;            var opId = GenerateOperationId();&#10;            using var scope = _logger.BeginScope(new Dictionary&lt;string, object&gt;&#10;            {&#10;                [&quot;OperationId&quot;] = opId,&#10;                [&quot;SKU&quot;] = request.SKU,&#10;                [&quot;Category&quot;] = request.Category.ToString()&#10;            });&#10;&#10;            var totalSw = Stopwatch.StartNew();&#10;&#10;            _logger.LogInformation(new EventId(ProductLogEvents.ProductCreationStarted, nameof(ProductLogEvents.ProductCreationStarted)),&#10;                &quot;Starting product creation. Name={Name}, Brand={Brand}, SKU={SKU}, Category={Category}&quot;,&#10;                request.Name, request.Brand, request.SKU, request.Category);&#10;&#10;            TimeSpan validationDuration = TimeSpan.Zero;&#10;            TimeSpan dbDuration = TimeSpan.Zero;&#10;&#10;            try&#10;            {&#10;                // Validation phase timing&#10;                var validationSw = Stopwatch.StartNew();&#10;&#10;                _logger.LogInformation(new EventId(ProductLogEvents.SKUValidationPerformed, nameof(ProductLogEvents.SKUValidationPerformed)),&#10;                    &quot;Validating SKU uniqueness. SKU={SKU}&quot;, request.SKU);&#10;&#10;                if (string.IsNullOrWhiteSpace(request.SKU))&#10;                {&#10;                    throw new ArgumentException(&quot;SKU is required&quot;, nameof(request.SKU));&#10;                }&#10;&#10;                if (await _repo.SkuExistsAsync(request.SKU, ct))&#10;                {&#10;                    _logger.LogWarning(new EventId(ProductLogEvents.ProductValidationFailed, nameof(ProductLogEvents.ProductValidationFailed)),&#10;                        &quot;SKU already exists. SKU={SKU}&quot;, request.SKU);&#10;                    throw new InvalidOperationException($&quot;Product with SKU '{request.SKU}' already exists.&quot;);&#10;                }&#10;&#10;                _logger.LogInformation(new EventId(ProductLogEvents.StockValidationPerformed, nameof(ProductLogEvents.StockValidationPerformed)),&#10;                    &quot;Validating stock. StockQuantity={Stock}&quot;, request.StockQuantity);&#10;&#10;                if (request.StockQuantity &lt; 0)&#10;                {&#10;                    _logger.LogWarning(new EventId(ProductLogEvents.ProductValidationFailed, nameof(ProductLogEvents.ProductValidationFailed)),&#10;                        &quot;Invalid stock quantity. StockQuantity={Stock}&quot;, request.StockQuantity);&#10;                    throw new ArgumentOutOfRangeException(nameof(request.StockQuantity), &quot;Stock quantity cannot be negative.&quot;);&#10;                }&#10;&#10;                validationSw.Stop();&#10;                validationDuration = validationSw.Elapsed;&#10;&#10;                // Map to Product using advanced mapping&#10;                var product = _mapper.Map&lt;Product&gt;(request);&#10;&#10;                // DB operations timing&#10;                var dbSw = Stopwatch.StartNew();&#10;                _logger.LogInformation(new EventId(ProductLogEvents.DatabaseOperationStarted, nameof(ProductLogEvents.DatabaseOperationStarted)),&#10;                    &quot;Adding product to database. SKU={SKU}&quot;, product.SKU);&#10;&#10;                await _repo.AddAsync(product, ct);&#10;                await _repo.SaveChangesAsync(ct);&#10;&#10;                dbSw.Stop();&#10;                dbDuration = dbSw.Elapsed;&#10;&#10;                _logger.LogInformation(new EventId(ProductLogEvents.DatabaseOperationCompleted, nameof(ProductLogEvents.DatabaseOperationCompleted)),&#10;                    &quot;Database operation completed. ProductId={ProductId}&quot;, product.Id);&#10;&#10;                // Cache invalidation&#10;                await _cache.RemoveAsync(&quot;all_products&quot;, ct);&#10;                _logger.LogInformation(new EventId(ProductLogEvents.CacheOperationPerformed, nameof(ProductLogEvents.CacheOperationPerformed)),&#10;                    &quot;Cache invalidated. Key={Key}&quot;, &quot;all_products&quot;);&#10;&#10;                // Map to DTO with conditional mapping/resolvers&#10;                var dto = _mapper.Map&lt;ProductProfileDto&gt;(product);&#10;&#10;                totalSw.Stop();&#10;                var metrics = new ProductCreationMetrics(&#10;                    OperationId: opId,&#10;                    ProductName: product.Name,&#10;                    SKU: product.SKU,&#10;                    Category: product.Category,&#10;                    ValidationDuration: validationDuration,&#10;                    DatabaseSaveDuration: dbDuration,&#10;                    TotalDuration: totalSw.Elapsed,&#10;                    Success: true,&#10;                    ErrorReason: null&#10;                );&#10;&#10;                _logger.LogProductCreationMetrics(metrics);&#10;&#10;                return dto;&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                totalSw.Stop();&#10;                var metrics = new ProductCreationMetrics(&#10;                    OperationId: opId,&#10;                    ProductName: request.Name,&#10;                    SKU: request.SKU,&#10;                    Category: request.Category,&#10;                    ValidationDuration: validationDuration,&#10;                    DatabaseSaveDuration: dbDuration,&#10;                    TotalDuration: totalSw.Elapsed,&#10;                    Success: false,&#10;                    ErrorReason: ex.Message&#10;                );&#10;&#10;                _logger.LogError(new EventId(ProductLogEvents.ProductValidationFailed, nameof(ProductLogEvents.ProductValidationFailed)), ex,&#10;                    &quot;Product creation failed. Name={Name}, SKU={SKU}, Category={Category}, Reason={Reason}&quot;,&#10;                    request.Name, request.SKU, request.Category, ex.Message);&#10;&#10;                _logger.LogProductCreationMetrics(metrics);&#10;                throw;&#10;            }&#10;        }&#10;&#10;        private static string GenerateOperationId()&#10;        {&#10;            const string chars = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;;&#10;            var bytes = new byte[8];&#10;            RandomNumberGenerator.Fill(bytes);&#10;            var sb = new StringBuilder(8);&#10;            foreach (var b in bytes)&#10;            {&#10;                sb.Append(chars[b % chars.Length]);&#10;            }&#10;            return sb.ToString();&#10;        }&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/Models/ProductCategory.cs">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/Models/ProductCategory.cs" />
              <option name="updatedContent" value="using System;&#10;&#10;namespace ProductModule&#10;{&#10;    public enum ProductCategory&#10;    {&#10;        Electronics = 0,&#10;        Clothing = 1,&#10;        Books = 2,&#10;        Home = 3&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>